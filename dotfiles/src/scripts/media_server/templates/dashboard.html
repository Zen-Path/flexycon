<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Live Dashboard</title>
        <!-- FontAwesome for Icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>
            body {
                font-family: "Segoe UI", sans-serif;
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
                background-color: #f4f6f8;
            }

            /* Header */
            .header-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                gap: 15px;
            }

            /* Search Bar */
            .search-container {
                position: relative;
                flex-grow: 1;
                max-width: 400px;
            }

            #searchInput {
                width: 100%;
                padding: 10px 35px 10px 10px;
                border-radius: 4px;
                border: 1px solid #ccc;
                box-sizing: border-box;
            }

            /* The X Button */
            .clear-search {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                color: #999;
                display: none;
                /* Hidden by default */
            }

            .clear-search:hover {
                color: #333;
            }

            /* Delete Visible Button */
            .danger-btn {
                background-color: #e74c3c;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .danger-btn:hover {
                background-color: #c0392b;
            }

            /* --- Table --- */
            table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            th {
                text-align: left;
                padding: 15px;
                color: #555;
                cursor: pointer;
                user-select: none;
                background: #fafafa;
                border-bottom: 2px solid #eee;
                position: relative;
            }

            td {
                padding: 15px;
                border-bottom: 1px solid #eee;
                vertical-align: middle;
            }

            /* Hover Effect */
            tr.data-row {
                transition: background-color 0.2s ease;
            }

            tr.data-row:hover {
                background-color: #eef2f7;
            }

            /* Sorting: Hidden unless active */
            th::after {
                content: none;
                font-family: "Font Awesome 6 Free";
                font-weight: 900;
                position: absolute;
                right: 10px;
            }

            /* Only show arrow when class is present */
            th.asc::after {
                content: "\f0de";
                color: #3498db;
            }

            /* Up Arrow */
            th.desc::after {
                content: "\f0dd";
                color: #3498db;
            }

            /* Down Arrow */

            /* Highlight active column header */
            th.active {
                color: #2c3e50;
                font-weight: bold;
                background-color: #f1f1f1;
            }

            /* --- Columns --- */
            .col-id {
                width: 50px;
                color: #aaa;
                font-size: 0.9em;
            }

            .col-type {
                width: 120px;
            }

            .col-title {
                max-width: 500px;
            }

            .col-time {
                font-family: "Consolas", monospace;
                color: #d35400;
                /* TODO: When implementing the help message, set cursor back to help */
                /* cursor: help; */
                width: 180px;
            }

            .col-actions {
                width: 100px;
                text-align: center;
            }

            /* --- Action Buttons --- */
            .action-btn {
                border: none;
                background: none;
                cursor: pointer;
                padding: 5px;
                font-size: 1.1em;
                transition: transform 0.1s;
            }

            .action-btn:hover {
                transform: scale(1.2);
            }

            .btn-edit {
                color: #f39c12;
            }

            .btn-delete {
                color: #e74c3c;
            }

            /* --- Type Icons --- */
            .type-badge {
                display: flex;
                align-items: center;
                gap: 8px;
                font-weight: 500;
                font-size: 0.9em;
            }

            .icon-box {
                width: 24px;
                text-align: center;
            }

            .type-image {
                color: #2980b9;
            }

            .type-video {
                color: #c0392b;
            }

            .type-gallery {
                color: #27ae60;
            }

            .type-unknown {
                color: #7f8c8d;
            }

            .title-text {
                display: block;
                font-weight: 600;
                color: #2c3e50;
                /* max-width: 450px; */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .url-subtext {
                display: block;
                font-size: 0.8em;
                color: #95a5a6;
                margin-top: 4px;
            }

            a {
                text-decoration: none;
                color: inherit;
            }

            .new-row {
                animation: flash 1s ease-out;
            }

            @keyframes flash {
                from {
                    background-color: #fffcdd;
                }

                to {
                    background-color: transparent;
                }
            }

            /* --- Modal Styles --- */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .modal {
                background: white;
                padding: 25px;
                border-radius: 8px;
                width: 400px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            }

            .modal h3 {
                margin-top: 0;
                color: #333;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #555;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }

            .modal-actions {
                text-align: right;
                margin-top: 20px;
            }

            .modal-btn {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 10px;
            }

            .btn-save {
                background: #3498db;
                color: white;
            }

            .btn-save:hover {
                background: #2980b9;
            }

            .btn-cancel {
                background: #eee;
                color: #333;
            }

            .btn-cancel:hover {
                background: #ddd;
            }
        </style>
    </head>

    <body>
        <div class="header-row">
            <h2>Download History</h2>

            <!-- Search with X button -->
            <div class="search-container">
                <input
                    type="text"
                    id="searchInput"
                    oninput="filterTable()"
                    placeholder="Search title or URL..." />
                <i
                    class="fa-solid fa-times clear-search"
                    id="clearBtn"
                    onclick="clearSearch()"></i>
            </div>

            <!-- Delete Visible Button -->
            <button class="danger-btn" onclick="deleteVisible()">
                <i class="fa-solid fa-trash-can"></i> Delete Visible
            </button>
        </div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th id="th-id" onclick="sortTable('id')">ID</th>
                    <th id="th-media_type" onclick="sortTable('media_type')">
                        Type
                    </th>
                    <th id="th-title" onclick="sortTable('title')">
                        Title / URL
                    </th>
                    <th id="th-start_time" onclick="sortTable('start_time')">
                        Start Time
                    </th>
                    <!-- Actions Column (No sorting) -->
                    <th class="col-actions">Actions</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Rows go here -->
            </tbody>
        </table>

        <!-- Edit Modal -->
        <div class="modal-overlay" id="editModal">
            <div class="modal">
                <h3>Edit Entry</h3>
                <input type="hidden" id="editId" />

                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="editTitle" />
                </div>

                <div class="form-group">
                    <label>Media Type</label>
                    <select id="editMediaType">
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                        <option value="gallery">Gallery</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button class="modal-btn btn-cancel" onclick="closeModal()">
                        Cancel
                    </button>
                    <button class="modal-btn btn-save" onclick="saveEdit()">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <script>
            const tableBody = document.getElementById("table-body");
            let allData = [];
            let currentSortCol = "id";
            let currentSortDir = -1; // -1 = DESC

            const apiKey = "{{ config['MEDIA_SERVER_KEY'] }}";

            // --- Initial Load ---
            fetch("/api/history", {
                headers: { "X-API-Key": apiKey },
            })
                .then((response) => response.json())
                .then((data) => {
                    data.forEach((item) => addRowToData(item, false));
                    updateSortHeaders();
                    renderTable();
                });

            // --- Real-Time Listener ---
            const eventSource = new EventSource(
                `/api/stream?api_key=${apiKey}`
            );
            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);
                addRowToData(data, true);
                renderTable();
            };

            function addRowToData(item, isNew) {
                item.isNew = isNew;
                allData.unshift(item);
            }

            // --- DELETE LOGIC ---

            function deleteEntry(id) {
                if (!confirm("Are you sure you want to delete this entry?"))
                    return;

                fetch(`/api/entry/${id}`, {
                    method: "DELETE",
                    headers: {
                        "X-API-Key": apiKey,
                    },
                }).then(() => {
                    // Remove from local array
                    allData = allData.filter((item) => item.id !== id);
                    renderTable();
                });
            }

            function deleteVisible() {
                // 1. Calculate currently visible IDs
                const searchTerm = document
                    .getElementById("searchInput")
                    .value.toLowerCase();
                const visibleItems = allData.filter((row) => {
                    const displayText = (row.title || row.url).toLowerCase();
                    return displayText.includes(searchTerm);
                });

                if (visibleItems.length === 0) {
                    alert("No items visible to delete.");
                    return;
                }

                if (
                    !confirm(
                        `Delete all ${visibleItems.length} visible entries? This cannot be undone.`
                    )
                )
                    return;

                const ids = visibleItems.map((item) => item.id);

                fetch("/api/delete_bulk", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-API-Key": apiKey,
                    },
                    body: JSON.stringify({ ids: ids }),
                })
                    .then((res) => res.json())
                    .then((data) => {
                        // Remove deleted IDs from local memory
                        allData = allData.filter(
                            (item) => !ids.includes(item.id)
                        );
                        renderTable();
                    });
            }

            // --- EDIT LOGIC ---

            function openEditModal(id) {
                const item = allData.find((r) => r.id === id);
                if (!item) return;

                document.getElementById("editId").value = id;
                document.getElementById("editTitle").value = item.title;
                document.getElementById("editMediaType").value =
                    item.media_type;
                document.getElementById("editModal").style.display = "flex";
            }

            function closeModal() {
                document.getElementById("editModal").style.display = "none";
            }

            function saveEdit() {
                const id = parseInt(document.getElementById("editId").value);
                const newTitle = document.getElementById("editTitle").value;
                const newType = document.getElementById("editMediaType").value;

                fetch(`/api/entry/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "X-API-Key": apiKey,
                    },
                    body: JSON.stringify({
                        title: newTitle,
                        media_type: newType,
                    }),
                })
                    .then((res) => res.json())
                    .then(() => {
                        // Update local memory
                        const item = allData.find((r) => r.id === id);
                        if (item) {
                            item.title = newTitle;
                            item.media_type = newType;
                        }
                        closeModal();
                        renderTable();
                    });
            }

            // --- SEARCH LOGIC ---
            function filterTable() {
                const input = document.getElementById("searchInput");
                const clearBtn = document.getElementById("clearBtn");

                // Show X if text exists
                if (input.value.length > 0) {
                    clearBtn.style.display = "block";
                } else {
                    clearBtn.style.display = "none";
                }
                renderTable();
            }

            function clearSearch() {
                const input = document.getElementById("searchInput");
                input.value = "";
                filterTable();
                input.focus();
            }

            // --- RENDERING LOGIC ---
            function getIconHtml(type) {
                const map = {
                    image: {
                        icon: "fa-image",
                        class: "type-image",
                        label: "Image",
                    },
                    video: {
                        icon: "fa-film",
                        class: "type-video",
                        label: "Video",
                    },
                    gallery: {
                        icon: "fa-layer-group",
                        class: "type-gallery",
                        label: "Gallery",
                    },
                    unknown: {
                        icon: "fa-circle-question",
                        class: "type-unknown",
                        label: "Unknown",
                    },
                };
                const t = map[type] || map["unknown"];
                return `<div class="type-badge ${t.class}">
                        <div class="icon-box"><i class="fa-solid ${t.icon}"></i></div>
                        <span>${t.label}</span>
                    </div>`;
            }

            function renderTable() {
                const searchTerm = document
                    .getElementById("searchInput")
                    .value.toLowerCase();
                tableBody.innerHTML = "";

                // Sort logic
                allData.sort((a, b) => {
                    let valA = a[currentSortCol];
                    let valB = b[currentSortCol];

                    if (currentSortCol === "title") {
                        valA = (a.title || a.url).toLowerCase();
                        valB = (b.title || b.url).toLowerCase();
                    }
                    if (valA < valB) return -1 * currentSortDir;
                    if (valA > valB) return 1 * currentSortDir;
                    return 0;
                });

                // Render Loop
                allData.forEach((row) => {
                    const displayText = (row.title || row.url).toLowerCase();
                    if (!displayText.includes(searchTerm)) return;

                    const tr = document.createElement("tr");
                    tr.classList.add("data-row");
                    if (row.isNew) {
                        tr.classList.add("new-row");
                        row.isNew = false;
                    }

                    const titleDisplay =
                        row.title && row.title !== "No Title Found"
                            ? `<span class="title-text" title="${row.title}">${row.title}</span><span class="url-subtext">${row.url}</span>`
                            : `<span class="title-text">${row.url}</span>`;

                    tr.innerHTML = `
                    <td class="col-id">#${row.id}</td>
                    <td class="col-type">${getIconHtml(row.media_type)}</td>
                    <td class="col-title"><a href="${row.url}" target="_blank">${titleDisplay}</a></td>
                    <td class="col-time">${row.start_time}</td>
                    <td class="col-actions">
                        <button class="action-btn btn-edit" onclick="openEditModal(${row.id})" title="Edit">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteEntry(${row.id})" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                    tableBody.appendChild(tr);
                });
            }

            // --- SORTING LOGIC ---
            function sortTable(key) {
                if (currentSortCol === key) {
                    currentSortDir *= -1; // Toggle
                } else {
                    currentSortCol = key;
                    currentSortDir = 1; // Default ASC
                }
                updateSortHeaders();
                renderTable();
            }

            function updateSortHeaders() {
                // 1. Reset all headers
                document.querySelectorAll("th").forEach((th) => {
                    th.classList.remove("asc", "desc", "active");
                });

                // 2. Apply classes to active header
                const activeTh = document.getElementById(
                    `th-${currentSortCol}`
                );
                if (activeTh) {
                    activeTh.classList.add("active");
                    activeTh.classList.add(
                        currentSortDir === 1 ? "asc" : "desc"
                    );
                }
            }
        </script>
    </body>
</html>
